name: Flowzone

on:
  workflow_call:
    secrets:
      FLOWZONE_TOKEN:
        description: "Personal access token (PAT) for the GitHub service account with admin/owner permissions"
        required: true
      NPM_TOKEN:
        description: "The NPM auth token to use for publishing"
        required: false
      GHCR_TOKEN:
        description: "A personal access token to publish to the GitHub Container Registry, will use FLOWZONE_TOKEN if unset"
        required: false
      DOCKER_REGISTRY_USER:
        description: "Username to publish to the Docker Hub container registry"
        required: false
      DOCKER_REGISTRY_PASS:
        description: "A personal access token to publish to the Docker Hub container registry"
        required: false
      BALENA_API_KEY_PUSH:
        description: "API key for pushing releases to balena applications"
        required: false
      COMPOSE_VARS:
        description: "Optional base64 encoded docker-compose `.env` file for testing Docker images"
        required: false
      GPG_PRIVATE_KEY:
        description: "GPG private key exported with `gpg --armor --export-secret-keys ...` to sign commits"
        required: true
      GPG_PASSPHRASE:
        description: "Passphrase to decrypt GPG private key"
        required: true
    inputs:
      working_directory:
        description: "GitHub actions working directory"
        type: string
        required: false
        default: "."
      required_approving_review_count:
        description: "Setting this value to zero effectively means merge==deploy without approval(s)"
        type: string
        required: false
        default: "1"
      dockerhub_repo:
        description: "Docker Hub repository for Docker projects, skipped if empty"
        type: string
        required: false
      ghcr_repo:
        description: "GitHub Container Registry repository for Docker projects, skipped if empty"
        type: string
        required: false
        default: ${{ github.repository }}
      docker_cache_from:
        description: "Newline separated list of additional external cache sources"
        type: string
        required: false
      docker_platforms:
        description: "Newline separated list of Docker target platforms"
        type: string
        required: false
        default: |
          linux/amd64
          linux/arm64
          linux/arm/v7
      docker_context:
        description: "Docker build context directory"
        type: string
        required: false
      docker_file:
        description: "Path to the Dockerfile relative to the context"
        type: string
        required: false
      docker_target:
        description: "Sets the target stage to build"
        type: string
        required: false
      balena_slugs:
        description: "Newline separated list of balenaCloud apps, fleets, or blocks to deploy"
        type: string
        required: false
        default: |
          ${{ github.repository }}-amd64
          ${{ github.repository }}-aarch64
          ${{ github.repository }}-armv7hf
      node_versions:
        description: "Newline separated list of Node.js versions to test"
        type: string
        required: false
        default: |
          14.x
          16.x
          18.x
      npm_registry:
        description: "NPM repository for NodeJS projects, skipped if empty"
        type: string
        required: false
        default: registry.npmjs.org
      protect_branch:
        description: "Set to false to disable updating branch protection rules after a successful run"
        type: boolean
        required: false
        default: true
      verbose:
        description: "Shell command tracing"
        type: boolean
        required: false
        default: false

env:
  GHCR_USER: "flowzone" # does not seem to matter what is used here
  GHCR_TOKEN: ${{ secrets.GHCR_TOKEN || secrets.FLOWZONE_TOKEN }}

jobs:
  ###################################################
  ## GENERAL
  ###################################################

  context_check:
    name: Context check
    runs-on: ubuntu-latest
    # limit to only Flowzone supported event types here as all other jobs depend on this one
    if: |
      ( github.event_name == 'pull_request' && github.base_ref == github.event.repository.default_branch && github.event.action == 'opened') ||
      ( github.event_name == 'pull_request' && github.base_ref == github.event.repository.default_branch && github.event.action == 'synchronize') ||
      ( github.event_name == 'pull_request' && github.base_ref == github.event.repository.default_branch && github.event.action == 'closed' && github.event.pull_request.merged == true) ||
      ( github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && contains(github.event.head_commit.author.name, 'versionbot') != true )

    outputs:
      balena_slugs: ${{ steps.balena_slugs.outputs.build }}
      docker_platforms: ${{ steps.docker_platforms.outputs.build }}
      node_versions: ${{ steps.node_versions.outputs.build }}
      ghcr_repo: ${{ steps.ghcr_repo.outputs.value }}
      dockerhub_repo: ${{ steps.dockerhub_repo.outputs.value }}

    steps:
      # - name: Dump GitHub context
      #   run: |
      #     echo '${{ toJSON(github) }}'

      - name: Convert to a JSON array
        id: balena_slugs
        uses: kanga333/json-array-builder@v0.1.0
        with:
          str: ${{ inputs.balena_slugs }}
          separator: "newline"

      - name: Convert to a JSON array
        id: docker_platforms
        uses: kanga333/json-array-builder@v0.1.0
        with:
          str: ${{ inputs.docker_platforms }}
          separator: "newline"

      - name: Convert to a JSON array
        id: node_versions
        uses: kanga333/json-array-builder@v0.1.0
        with:
          str: ${{ inputs.node_versions }}
          separator: "newline"

      - name: Add ghcr.io prefix
        if: inputs.ghcr_repo != ''
        id: ghcr_repo
        run: |
          echo "::set-output name=value::$(echo ghcr.io/${{ inputs.ghcr_repo }})"

      - name: Add docker.io prefix
        if: inputs.dockerhub_repo != ''
        id: dockerhub_repo
        run: |
          echo "::set-output name=value::$(echo docker.io/${{ inputs.dockerhub_repo }})"

  source_check:
    name: Source check
    runs-on: ubuntu-latest
    needs: [context_check]

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
        shell: bash

    outputs:
      npm: ${{ steps.npm.outputs.enabled }}
      docker: ${{ steps.docker.outputs.enabled }}
      balena: ${{ steps.balena.outputs.enabled }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.FLOWZONE_TOKEN }}

      - name: Check for package.json
        id: npm
        run: |
          if test -f "package.json"; then
            echo "found package.json"
            echo "::set-output name=enabled::true"
          else
            echo ::set-output name=enabled::"false"
          fi

      - name: Check for docker-compose.test.yml
        id: docker
        run: |
          if [ -f docker-compose.test.yml ] && [ -f docker-compose.yml ]; then
            echo "found docker-compose.test.yml"
            echo ::set-output name=enabled::"true"
          else
            echo ::set-output name=enabled::"false"
          fi

      - name: Check for balena.yml
        id: balena
        run: |
          if test -f balena.yml
          then
            echo "found balena.yml"
            echo ::set-output name=enabled::"true"
          else
            echo ::set-output name=enabled::"false"
          fi

  protect_branch:
    name: Protect branch
    needs: [context_check, version_draft, docker_draft, npm_draft, balena_draft]
    runs-on: ubuntu-latest
    # run if all the test jobs are success or skipped, but still require context and version checks to be success
    if: "!failure() && !cancelled() && needs.context_check.result == 'success' && needs.version_draft.result == 'success' && inputs.protect_branch == true"

    outputs:
      result: ${{ steps.apply_branch_protection_rules.outputs.result }}

    defaults:
      run:
        working-directory: .
        shell: bash

    steps:
      - name: Apply branch protection rules
        id: apply_branch_protection_rules
        run: |
          url='${{ github.api_url }}/repos/${{ github.repository }}/branches/${{ github.event.repository.default_branch }}/protection'

          result="$(curl --silent -X PUT "${url}" \
            -H 'Accept: application/vnd.github+json' \
            -H 'Authorization: Bearer ${{ secrets.FLOWZONE_TOKEN }}' \
            -d '{
            "required_status_checks": {
              "strict": true,
              "contexts": [
                "Flowzone / Context check",
                "Flowzone / Source check",
                "Flowzone / Protect branch",
                "Flowzone / Version draft",
                "Flowzone / NPM draft",
                "Flowzone / Docker draft",
                "Flowzone / balena draft",
                "VersionBot/generate-version"
              ]
            },
            "enforce_admins": false,
            "required_pull_request_reviews": {
              "dismissal_restrictions": {
                "users": [],
                "teams": []
              },
              "dismiss_stale_reviews": false,
              "require_code_owner_reviews": false,
              "required_approving_review_count": ${{ inputs.required_approving_review_count }},
              "bypass_pull_request_allowances": {
                "users": [],
                "teams": []
              }
            },
            "restrictions": null,
            "required_linear_history": false,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "block_creations": false,
            "required_conversation_resolution": false
          }')"

          echo ::set-output name=result::"${result}"

  ###################################################
  ## VERSIONING
  ###################################################

  version_draft:
    name: Version draft
    runs-on: ubuntu-latest
    # only run on PR open or synchronize events
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    needs: [source_check]

    defaults:
      run:
        working-directory: .
        shell: bash

    outputs:
      versionbot: ${{ steps.versionbot_checkout.outcome }}

    steps:
      - name: Checkout versioned source
        id: versionbot_checkout
        continue-on-error: true
        uses: actions/checkout@v3
        with:
          ref: versionbot/pr/${{ github.event.pull_request.number }}
          fetch-depth: 2
          token: ${{ secrets.FLOWZONE_TOKEN }}

      - name: Assert that versioned source is up-to-date
        if: ${{ steps.versionbot_checkout.outcome == 'success' }}
        run: git merge-base --is-ancestor ${{ github.event.pull_request.head.sha }} HEAD

      # Fallback to unversioned source if versionbot branch does not exist
      - name: Checkout original source
        if: ${{ steps.versionbot_checkout.outcome == 'failure' }}
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          token: ${{ secrets.FLOWZONE_TOKEN }}

      # Run balena-versionist in Github actions when the versionbot branch could not be checked out
      - name: Version original source
        if: ${{ steps.versionbot_checkout.outcome == 'failure' }}
        run: |
          npm install -g balena-versionist versionist
          balena-versionist

      # https://github.com/actions/upload-artifact#maintaining-file-permissions-and-case-sensitive-files
      - name: Compress source
        run: tar -cvf /tmp/versioned-source.tar .

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: versioned-source-${{ github.event.pull_request.head.sha }}
          path: /tmp/versioned-source.tar

  version_merge:
    name: Version merge
    needs: [context_check, source_check]
    runs-on: ubuntu-latest
    # only run on PR merge events
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true

    defaults:
      run:
        working-directory: .
        shell: bash

    outputs:
      sha: ${{ steps.versioned.outputs.sha }}
      raw: ${{ steps.versioned.outputs.raw }}
      semver: ${{ steps.versioned.outputs.semver }}
      author: ${{ steps.author.outputs.name }}
      versionbot: ${{ contains(steps.author.outputs.name, 'versionbot') }}

    steps:
      - name: Download artifact
        id: download
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.FLOWZONE_TOKEN }}
          workflow_conclusion: success
          pr: ${{ github.event.pull_request.number }}
          name: versioned-source-${{ github.event.pull_request.head.sha }}
          search_artifacts: true

      - name: Extract source
        run: |
          mkdir -p /tmp/versioned-source
          tar -xvf versioned-source.tar -C /tmp/versioned-source

      - name: Check author
        id: author
        working-directory: /tmp/versioned-source
        run: |
          echo "::set-output name=name::$(git log -1 --pretty=format:'%an' | xargs)"

      - name: Parse version
        id: versioned
        if: contains(steps.author.outputs.name, 'versionbot')
        working-directory: /tmp/versioned-source
        run: |
          VERSION="$(head -n1 VERSION || jq -r '.version' package.json)"
          echo "::set-output name=sha::$(git rev-parse HEAD)"
          echo "::set-output name=raw::v${VERSION}"
          echo "::set-output name=semver::${VERSION}"

      - name: Import GPG key for signing commits
        id: import-gpg
        if: contains(steps.author.outputs.name, 'versionbot')
        uses: crazy-max/ghaction-import-gpg@v4
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_config_global: true
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Checkout source
        if: contains(steps.author.outputs.name, 'versionbot')
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.FLOWZONE_TOKEN }}

      - name: Push versioned commit
        if: contains(steps.author.outputs.name, 'versionbot')
        env:
          BRANCH: ${{ github.base_ref }}
          GIT_AUTHOR_NAME: ${{ steps.import-gpg.outputs.name }}
          GIT_AUTHOR_EMAIL: ${{ steps.import-gpg.outputs.email }}
          GIT_COMMITTER_NAME: ${{ steps.import-gpg.outputs.name }}
          GIT_COMMITTER_EMAIL: ${{ steps.import-gpg.outputs.email }}
          VERSION: ${{ steps.versioned.outputs.raw }}
          REV: ${{ steps.versioned.outputs.sha }}
        run: |
          git --git-dir=/tmp/versioned-source/.git format-patch -k -1 --stdout ${REV} | git am -3 -k
          git tag -a "${VERSION}" -m "${VERSION}"
          git push origin HEAD:${BRANCH} --follow-tags

  version_tag:
    name: Version tag
    needs: [context_check, source_check]
    runs-on: ubuntu-latest
    # only run on tag push events
    if: github.event_name == 'push'

    outputs:
      raw: github.ref_name
      semver: steps.format.outputs.semver

    defaults:
      run:
        working-directory: .
        shell: bash

    steps:
      - name: Format tag as semver
        id: format
        run: |
          echo "::set-output name=semver::$(npx -q -y -- semver -c -l ${{ github.ref_name }})"

  ###################################################
  ## NPM
  ###################################################

  npm_matrix:
    name: NPM
    runs-on: ubuntu-latest
    needs: [version_draft, source_check, context_check]
    if: needs.source_check.outputs.npm == 'true'

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
        shell: bash

    strategy:
      fail-fast: false
      matrix:
        node_version: ${{ fromJSON(needs.context_check.outputs.node_versions) }}

    steps:
      - name: Download versioned source
        uses: actions/download-artifact@v3
        with:
          name: versioned-source-${{ github.event.pull_request.head.sha }}

      - name: Extract versioned source
        working-directory: .
        run: tar -xvf versioned-source.tar

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "${{ matrix.node_version }}"

      - name: Install dependencies
        run: |
          if [ -e package-lock.json ]; then
            npm ci
          else
            npm i
          fi

      - name: Run build
        run: npm run build --if-present

      - name: Run tests
        run: npm test

  npm_draft:
    name: NPM draft
    runs-on: ubuntu-latest
    needs: [npm_matrix, source_check]
    if: inputs.npm_registry != ''

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
        shell: bash

    steps:
      - name: Download versioned source
        uses: actions/download-artifact@v3
        with:
          name: versioned-source-${{ github.event.pull_request.head.sha }}

      - name: Extract versioned source
        working-directory: .
        run: tar -xvf versioned-source.tar

      - name: Publish draft tag
        run: |
          if [[ '${{ inputs.verbose }}' =~ 1|on|On|Yes|yes|true|True ]]; then
              set -x
              env
          fi

          echo '//${{ inputs.npm_registry }}/:_authToken=${{ secrets.NPM_TOKEN }}' > ~/.npmrc

          npm whoami

          if [[ "$(jq -r '.private' package.json)" =~ true ]]; then
              access=restricted
          else
              access=public
          fi

          package="$(jq -r '.name' package.json)"
          version="$(jq -r '.version' package.json)"
          branch="$(echo '${{ github.event.pull_request.head.ref }}' | sed 's/[^[:alnum:]]/-/g')"
          tag="${branch}-${{ github.event.pull_request.head.sha }}"
          tmp_version="${version}-${tag}"

          npm --no-git-tag-version version "${tmp_version}"

          for t in "${tag}" "${branch}"; do
              npm dist-tag rm "${package}" "${t}" || true
          done

          npm publish --tag "${tag}" --access="${access}" \
            || find ~/.npm/_logs -name '*.log' | xargs cat

          for t in "${branch}" latest; do
              npm dist-tag add "${package}@${tmp_version}" "${t}" \
                || find ~/.npm/_logs -name '*.log' | xargs cat
          done

          npm dist-tag ls

  npm_merge:
    name: NPM merge
    needs: [context_check, source_check, version_merge]
    runs-on: ubuntu-latest
    if:
      needs.source_check.outputs.npm == 'true' &&
      inputs.npm_registry != ''

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
        shell: bash

    steps:
      - name: Download versioned source
        uses: actions/download-artifact@v3
        with:
          name: versioned-source-${{ github.event.pull_request.head.sha }}

      - name: Extract versioned source
        working-directory: .
        run: tar -xvf versioned-source.tar

      # use the versioned tag when merging PRs with versionbot
      - name: Publish versioned tag
        if: needs.version_merge.outputs.versionbot == 'true'
        run: |
          if [[ '${{ inputs.verbose }}' =~ 1|on|On|Yes|yes|true|True ]]; then
              set -x
              env
          fi

          echo '//${{ inputs.npm_registry }}/:_authToken=${{ secrets.NPM_TOKEN }}' > ~/.npmrc

          npm whoami

          if [[ "$(jq -r '.private' package.json)" =~ true ]]; then
              access=restricted
          else
              access=public
          fi

          version="$(jq -r '.version' package.json)"

          npm version --allow-same-version "${version}"

          npm publish --access="${access}" \
            || find ~/.npm/_logs -name '*.log' | xargs cat

          npm dist-tag ls


  ###################################################
  ## DOCKER
  ###################################################

  docker_matrix:
    name: Docker
    runs-on: ubuntu-latest
    needs: [version_draft, source_check, context_check]
    if: needs.source_check.outputs.docker == 'true'

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
        shell: bash

    env:
      COMPOSE_VARS: ${{ secrets.COMPOSE_VARS }}
      LOCAL_IMAGE: localhost:5000/sut
      LOCAL_TAG: localhost:5000/sut:latest

    services:
      registry:
        image: registry:2.8.1
        ports:
          - 5000:5000

    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJSON(needs.context_check.outputs.docker_platforms) }}

    steps:
      - name: Login to GitHub Container Registry
        if: ${{ needs.context_check.outputs.ghcr_repo != '' }}
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ env.GHCR_TOKEN }}

      - name: Login to Docker Hub
        if: ${{ needs.context_check.outputs.dockerhub_repo != '' }}
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_REGISTRY_USER }}
          password: ${{ secrets.DOCKER_REGISTRY_PASS }}

      - name: Download versioned source
        uses: actions/download-artifact@v3
        with:
          name: versioned-source-${{ github.event.pull_request.head.sha }}

      - name: Extract versioned source
        working-directory: .
        run: tar -xvf versioned-source.tar

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v2

      - name: Setup buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver-opts: network=host
          install: true

      - name: Sanitize suffix
        id: suffix
        run: |
          echo "::set-output name=string::$(echo ${{ matrix.platform }} | sed -e 's|linux/||' -e 's|/||')"

      - name: Generate Docker labels and tags
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ${{ needs.context_check.outputs.ghcr_repo }}
            ${{ needs.context_check.outputs.dockerhub_repo }}
            ${{ env.LOCAL_IMAGE }}
          tags: |
            type=raw,value=${{ github.event.pull_request.head.ref }},suffix=-${{ steps.suffix.outputs.string }}
            type=ref,event=pr,suffix=-${{ steps.suffix.outputs.string }}
            type=raw,value=${{ github.event.pull_request.head.sha }},suffix=-${{ steps.suffix.outputs.string }}
          flavor: |
            latest=false

      - name: Build and load
        id: build
        uses: docker/build-push-action@v3
        with:
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-to: type=gha,mode=max
          cache-from: |
            type=gha
            ${{ steps.meta.outputs.tags }}
            ${{ inputs.docker_cache_from }}
          context: ${{ inputs.docker_context || inputs.working_directory }}
          file: ${{ inputs.docker_file }}
          target: ${{ inputs.docker_target }}
          # extra tags for convenience, can be used in docker-compose.test.yml
          tags: |
            ${{ steps.meta.outputs.tags }}
            ${{ github.repository }}:latest
            sut:latest
            ${{ env.LOCAL_TAG }}
          load: true
          push: false

      - name: Run docker-compose tests
        run: |
          if [[ ! -z "${COMPOSE_VARS}" ]]; then
            echo ${COMPOSE_VARS} | base64 --decode > .env
          fi
          docker compose -f docker-compose.yml -f docker-compose.test.yml up --no-build --exit-code-from sut

      - name: Push image to local registry
        run: |
          docker push ${{ env.LOCAL_TAG }}

      - name: Push tags to public registries
        uses: akhilerm/tag-push-action@v2.0.0
        with:
          src: ${{ env.LOCAL_TAG }}
          dst: |
            ${{ steps.meta.outputs.tags }}

  docker_draft:
    name: Docker draft
    runs-on: ubuntu-latest
    needs: [docker_matrix, context_check]
    if: needs.context_check.outputs.ghcr_repo != '' || needs.context_check.outputs.dockerhub_repo != ''

    defaults:
      run:
        working-directory: .
        shell: bash

    steps:
      - name: Login to GitHub Container Registry
        if: ${{ needs.context_check.outputs.ghcr_repo != '' }}
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ env.GHCR_TOKEN }}

      - name: Login to Docker Hub
        if: ${{ needs.context_check.outputs.dockerhub_repo != '' }}
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_REGISTRY_USER }}
          password: ${{ secrets.DOCKER_REGISTRY_PASS }}

      - name: Generate Docker labels and tags
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ${{ needs.context_check.outputs.ghcr_repo }}
            ${{ needs.context_check.outputs.dockerhub_repo }}
          tags: |
            type=raw,value=${{ github.event.pull_request.head.ref }}
            type=ref,event=pr
          flavor: |
            latest=false

      - name: Create multi-arch manifest
        if: ${{ needs.context_check.outputs.ghcr_repo != '' }}
        uses: pixelfederation/gh-action-manifest-tool@v0.1.0
        with:
          username: ${{ env.GHCR_USER }}
          password: ${{ env.GHCR_TOKEN }}
          platforms: ${{ join(fromJSON(needs.context_check.outputs.docker_platforms)) }}
          template: ${{ needs.context_check.outputs.ghcr_repo }}:${{ github.event.pull_request.head.sha }}-ARCHVARIANT
          target: ${{ needs.context_check.outputs.ghcr_repo }}:${{ github.event.pull_request.head.sha }}
          # see https://github.com/estesp/manifest-tool to understand template

      - name: Create multi-arch manifest
        if: ${{ needs.context_check.outputs.dockerhub_repo != '' }}
        uses: pixelfederation/gh-action-manifest-tool@v0.1.0
        with:
          username: ${{ secrets.DOCKER_REGISTRY_USER }}
          password: ${{ secrets.DOCKER_REGISTRY_PASS }}
          platforms: ${{ join(fromJSON(needs.context_check.outputs.docker_platforms)) }}
          template: ${{ needs.context_check.outputs.dockerhub_repo }}:${{ github.event.pull_request.head.sha }}-ARCHVARIANT
          target: ${{ needs.context_check.outputs.dockerhub_repo }}:${{ github.event.pull_request.head.sha }}
          # see https://github.com/estesp/manifest-tool to understand template

      - name: Publish tags
        uses: akhilerm/tag-push-action@v2.0.0
        with:
          src: ${{ needs.context_check.outputs.ghcr_repo || needs.context_check.outputs.dockerhub_repo }}:${{ github.event.pull_request.head.sha }}
          dst: |
            ${{ steps.meta.outputs.tags }}

  docker_merge:
    name: Docker merge
    needs: [context_check, source_check, version_merge]
    runs-on: ubuntu-latest
    if: |
      needs.source_check.outputs.docker == 'true' &&
      (needs.context_check.outputs.ghcr_repo != '' || needs.context_check.outputs.dockerhub_repo != '')

    defaults:
      run:
        working-directory: .
        shell: bash

    steps:
      - name: Login to GitHub Container Registry
        if: ${{ needs.context_check.outputs.ghcr_repo != '' }}
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ env.GHCR_TOKEN }}

      - name: Login to Docker Hub
        if: ${{ needs.context_check.outputs.dockerhub_repo != '' }}
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_REGISTRY_USER }}
          password: ${{ secrets.DOCKER_REGISTRY_PASS }}

      # use the versioned tag when merging PRs with versionbot
      - name: Generate Docker labels and tags
        if: needs.version_merge.outputs.versionbot == 'true'
        id: versioned-meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ${{ needs.context_check.outputs.ghcr_repo }}
            ${{ needs.context_check.outputs.dockerhub_repo }}
          tags: |
            type=raw,value=${{ needs.version_merge.outputs.raw }}
            type=raw,value=${{ needs.version_merge.outputs.semver }}
          flavor: |
            latest=true

      # use the 'edge' tag when merging PRs without versionbot
      - name: Generate Docker labels and tags
        if: needs.version_merge.outputs.versionbot != 'true'
        id: edge-meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ${{ needs.context_check.outputs.ghcr_repo }}
            ${{ needs.context_check.outputs.dockerhub_repo }}
          tags: |
            type=raw,value=edge
          flavor: |
            latest=false

      - name: Publish tags
        uses: akhilerm/tag-push-action@v2.0.0
        with:
          src: ${{ needs.context_check.outputs.ghcr_repo || needs.context_check.outputs.dockerhub_repo }}:${{ github.event.pull_request.head.sha }}
          dst: |
            ${{ steps.versioned-meta.outputs.tags }}
            ${{ steps.edge-meta.outputs.tags }}

  docker_tag:
    name: Docker tag
    needs: [context_check, source_check, version_tag]
    runs-on: ubuntu-latest
    if: |
      needs.source_check.outputs.docker == 'true' &&
      (needs.context_check.outputs.ghcr_repo != '' || needs.context_check.outputs.dockerhub_repo != '')

    defaults:
      run:
        working-directory: .
        shell: bash

    steps:
      - name: Login to GitHub Container Registry
        if: ${{ needs.context_check.outputs.ghcr_repo != '' }}
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ env.GHCR_TOKEN }}

      - name: Login to Docker Hub
        if: ${{ needs.context_check.outputs.dockerhub_repo != '' }}
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_REGISTRY_USER }}
          password: ${{ secrets.DOCKER_REGISTRY_PASS }}

      - name: Generate Docker labels and tags
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ${{ needs.context_check.outputs.ghcr_repo }}
            ${{ needs.context_check.outputs.dockerhub_repo }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
          flavor: |
            latest=auto
            prefix=
            suffix=

      - name: Publish tags
        uses: akhilerm/tag-push-action@v2.0.0
        with:
          src: ${{ needs.context_check.outputs.ghcr_repo || needs.context_check.outputs.dockerhub_repo }}:${{ github.event.pull_request.head.sha }}
          dst: |
            ${{ steps.meta.outputs.tags }}

  ###################################################
  ## BALENA
  ###################################################

  balena_matrix:
    name: balena
    runs-on: ubuntu-latest
    needs: [version_draft, source_check, context_check]
    if: needs.source_check.outputs.balena == 'true'

    strategy:
      fail-fast: false
      matrix:
        slug: ${{ fromJSON(needs.context_check.outputs.balena_slugs) }}

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
        shell: bash

    steps:
      - name: Download versioned source
        uses: actions/download-artifact@v3
        with:
          name: versioned-source-${{ github.event.pull_request.head.sha }}

      - name: Extract versioned source
        working-directory: .
        run: tar -xvf versioned-source.tar

      - uses: balena-io/deploy-to-balena-action@v0.12.1
        with:
          balena_token: ${{ secrets.BALENA_API_KEY_PUSH }}
          fleet: ${{ matrix.slug }}
          versionbot: false # disable the included versionbot branch checkout
          source: ${{ inputs.working_directory }}

  balena_draft:
    name: balena draft
    runs-on: ubuntu-latest
    needs: [balena_matrix]

    defaults:
      run:
        working-directory: .
        shell: bash

    steps:
      # just a catchall to ensure the matrix was successful so we can use this job as
      # branch protection without knowing all the matrices
      - run: echo "nothing to do!"

  # balena_merge is functionally the same as balena_tag for now
  balena_merge:
    name: balena merge
    needs: [context_check, source_check, version_merge]
    runs-on: ubuntu-latest
    if: needs.source_check.outputs.balena == 'true'

    defaults:
      run:
        working-directory: .
        shell: bash

    strategy:
      fail-fast: false
      matrix:
        slug: ${{ fromJSON(needs.context_check.outputs.balena_slugs) }}

    steps:
      - uses: balena-io/deploy-to-balena-action@v0.12.1
        with:
          balena_token: ${{ secrets.BALENA_API_KEY_PUSH }}
          fleet: ${{ matrix.slug }}
          versionbot: false # disable the included versionbot branch checkout
          source: ${{ inputs.working_directory }}

  # balena_merge is functionally the same as balena_tag for now
  balena_tag:
    name: balena tag
    needs: [context_check, source_check, version_tag]
    runs-on: ubuntu-latest
    if: needs.source_check.outputs.balena == 'true'

    defaults:
      run:
        working-directory: .
        shell: bash

    strategy:
      fail-fast: false
      matrix:
        slug: ${{ fromJSON(needs.context_check.outputs.balena_slugs) }}

    steps:
      - uses: balena-io/deploy-to-balena-action@v0.12.1
        with:
          balena_token: ${{ secrets.BALENA_API_KEY_PUSH }}
          fleet: ${{ matrix.slug }}
          versionbot: false # disable the included versionbot branch checkout
          source: ${{ inputs.working_directory }}
